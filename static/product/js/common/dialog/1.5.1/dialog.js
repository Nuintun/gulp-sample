define("common/dialog/1.5.1/dialog",["./dialog.css.js","base/jquery/1.11.3/jquery","common/overlay/1.2.0/index","base/events/1.2.0/events","base/templatable/0.10.0/templatable","util/messenger/2.1.0/messenger","./dialog.tpl"],function(e,t,i){"use strict";e("./dialog.css.js");var s=e("base/jquery/1.11.3/jquery"),n=e("common/overlay/1.2.0/index"),a=n.Mask,r=e("base/events/1.2.0/events"),h=e("base/templatable/0.10.0/templatable"),l=e("util/messenger/2.1.0/messenger"),o=n.extend({Implements:h,attrs:{template:e("./dialog.tpl"),trigger:{value:null,getter:function(e){return s(e)}},classPrefix:"ui-dialog",content:{value:null,setter:function(e){return/^(https?:\/\/|\/|\.\/|\.\.\/)/.test(e)&&(this._type="iframe",(e.indexOf("?ajax")>0||e.indexOf("&ajax")>0)&&(this._ajax=!0)),e}},hasMask:!0,closeTpl:"Ã—",width:500,height:null,initialHeight:300,effect:"none",zIndex:999,autoFit:!0,align:{value:{selfXY:["50%","50%"],baseXY:["50%","42%"]},getter:function(e){return this.element.height()>.84*s(window).height()?{selfXY:["50%","0"],baseXY:["50%","0"]}:e}}},parseElement:function(){this.set("model",{classPrefix:this.get("classPrefix")}),o.superclass.parseElement.call(this),this.contentElement=this.$("[data-role=content]"),this.contentElement.css({height:"100%",zoom:1}),this.$(">[data-role=close]").hide()},events:{"click [data-role=close]":function(e){e.preventDefault(),this.hide()}},show:function(){return"iframe"===this._type&&(this._ajax?this._ajaxHtml():(!this.get("height")&&this.contentElement.css("height",this.get("initialHeight")),this._showIframe())),o.superclass.show.call(this),this},hide:function(){return"iframe"===this._type&&this.iframe&&(this._isCrossDomainIframe||this.iframe.attr({src:"javascript:'';"}),this.iframe.remove(),this.iframe=null),o.superclass.hide.call(this),clearInterval(this._interval),delete this._interval,this},destroy:function(){return this.element.remove(),this._hideMask(),clearInterval(this._interval),o.superclass.destroy.call(this)},setup:function(){o.superclass.setup.call(this),this._setupTrigger(),this._setupMask(),this._setupKeyEvents(),this._setupFocus(),c(this.element),c(this.get("trigger")),this.activeTrigger=this.get("trigger").eq(0)},_onRenderContent:function(e){if("iframe"!==this._type){var t;try{t=s(e)}catch(i){t=[]}t[0]?this.contentElement.empty().append(t):this.contentElement.empty().html(e),this._setPosition()}},_onRenderCloseTpl:function(e){""===e?this.$(">[data-role=close]").html(e).hide():this.$(">[data-role=close]").html(e).show()},_onRenderVisible:function(e){e?"fade"===this.get("effect")?this.element.fadeIn(300):this.element.show():this.element.hide()},_setupTrigger:function(){this.delegateEvents(this.get("trigger"),"click",function(e){e.preventDefault(),this.activeTrigger=s(e.currentTarget),this.show()})},_setupMask:function(){var e=this;a._dialogs=a._dialogs||[],this.after("show",function(){if(this.get("hasMask")){var t;a.set("zIndex",e.get("zIndex")).show(),a.element.insertBefore(e.element);for(var i=0;i<a._dialogs.length;i++)a._dialogs[i]===e&&(t=a._dialogs[i]);t?(g(t,a._dialogs),a._dialogs.push(t)):a._dialogs.push(e)}}),this.after("hide",this._hideMask)},_hideMask:function(){if(this.get("hasMask"))for(var e=a._dialogs?a._dialogs.length:0,t=0;t<e;t++)if(a._dialogs[t]===this)if(g(this,a._dialogs),0===a._dialogs.length)a.hide();else if(t===e-1){var i=a._dialogs[a._dialogs.length-1];a.set("zIndex",i.get("zIndex")),a.element.insertBefore(i.element)}},_setupFocus:function(){this.after("show",function(){this.element.focus()}),this.after("hide",function(){this.activeTrigger&&this.activeTrigger.focus()})},_setupKeyEvents:function(){this.delegateEvents(s(document),"keyup.esc",function(e){27===e.keyCode&&this.get("visible")&&this.hide()})},_showIframe:function(){var e=this;this.iframe||this._createIframe(),this.iframe.attr({src:this._fixUrl(),name:"dialog-iframe"+(new Date).getTime()}),this.iframe.one("load",function(){e.get("visible")&&(e._isCrossDomainIframe=function(e){var t=!1;try{return!!e[0].contentWindow.document}catch(i){t=!0}return t}(e.iframe),e._isCrossDomainIframe||(e.get("autoFit")&&(clearInterval(e._interval),e._interval=setInterval(function(){e._syncHeight()},300)),e._syncHeight()),e._setPosition(),e.trigger("complete:show"))})},_fixUrl:function(){var e=this.get("content").match(/([^?#]*)(\?[^#]*)?(#.*)?/);return e.shift(),e[1]=(e[1]&&"?"!==e[1]?e[1]+"&":"?")+"t="+(new Date).getTime(),e.join("")},_createIframe:function(){var e=this;this.iframe=s("<iframe>",{src:"javascript:'';",scrolling:"no",frameborder:"no",allowTransparency:"true",css:{border:"none",width:"100%",display:"block",height:"100%",overflow:"hidden"}}).appendTo(this.contentElement),r.mixTo(this.iframe[0]),this.iframe[0].on("close",function(){e.hide()});var t=new l("parent","arale-dialog");t.addTarget(this.iframe[0].contentWindow,"iframe1"),t.listen(function(t){switch((t=JSON.parse(t)).event){case"close":e.hide();break;case"syncHeight":e._setHeight("px"===t.height.toString().slice(-2)?t.height:t.height+"px")}})},_setHeight:function(e){this.contentElement.css("height",e),this.element[0].className=this.element[0].className},_syncHeight:function(){var e;if(this.get("height"))clearInterval(this._interval),delete this._interval;else{try{this._errCount=0,e=function(e){var t=e[0].contentWindow.document;if(t.body.scrollHeight&&t.documentElement.scrollHeight)return Math.min(t.body.scrollHeight,t.documentElement.scrollHeight);if(t.documentElement.scrollHeight)return t.documentElement.scrollHeight;if(t.body.scrollHeight)return t.body.scrollHeight}(this.iframe)+"px"}catch(t){this._errCount=(this._errCount||0)+1,this._errCount>=6&&(e=this.get("initialHeight"),clearInterval(this._interval),delete this._interval)}this._setHeight(e)}},_ajaxHtml:function(){var e=this;this.contentElement.css("height",this.get("initialHeight")),this.contentElement.load(this.get("content"),function(){e._setPosition(),e.contentElement.css("height",""),e.trigger("complete:show")})}});function c(e){null==e.attr("tabindex")&&e.attr("tabindex","-1")}function g(e,t){for(var i=-1,s=0;s<t.length;s++)if(t[s]===e){i=s;break}-1!==i&&t.splice(i,1)}i.exports=o});